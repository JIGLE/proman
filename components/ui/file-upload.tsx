"use client";\n\nimport * as React from \"react\";\nimport { cn } from \"@/lib/utils\";\nimport { Button } from \"./button\";\nimport { Progress } from \"./progress\";\nimport { \n  Upload, \n  File, \n  Image, \n  FileText, \n  Video, \n  Music, \n  Archive, \n  X, \n  Check, \n  AlertCircle, \n  Download,\n  Eye\n} from \"lucide-react\";\n\n// File type definitions\nexport interface UploadedFile {\n  id: string;\n  file: File;\n  name: string;\n  size: number;\n  type: string;\n  preview?: string;\n  progress?: number;\n  status: 'pending' | 'uploading' | 'success' | 'error';\n  error?: string;\n}\n\n// Enhanced file upload component\nexport interface FileUploadProps {\n  onFilesChange?: (files: UploadedFile[]) => void;\n  onUpload?: (files: File[]) => Promise<void>;\n  accept?: string;\n  multiple?: boolean;\n  maxFiles?: number;\n  maxFileSize?: number; // in bytes\n  disabled?: boolean;\n  className?: string;\n  label?: string;\n  description?: string;\n  error?: string;\n  required?: boolean;\n  showPreview?: boolean;\n  allowedTypes?: string[];\n  dragAndDrop?: boolean;\n  instantUpload?: boolean;\n  compress?: boolean;\n  resizeImages?: {\n    maxWidth: number;\n    maxHeight: number;\n    quality?: number;\n  };\n}\n\nexport function FileUpload({\n  onFilesChange,\n  onUpload,\n  accept,\n  multiple = false,\n  maxFiles = multiple ? 10 : 1,\n  maxFileSize = 10 * 1024 * 1024, // 10MB\n  disabled,\n  className,\n  label,\n  description,\n  error,\n  required,\n  showPreview = true,\n  allowedTypes,\n  dragAndDrop = true,\n  instantUpload = false,\n  compress = false,\n  resizeImages\n}: FileUploadProps) {\n  const [files, setFiles] = React.useState<UploadedFile[]>([]);\n  const [isDragOver, setIsDragOver] = React.useState(false);\n  const [isUploading, setIsUploading] = React.useState(false);\n  const fileInputRef = React.useRef<HTMLInputElement>(null);\n  const dragCounter = React.useRef(0);\n\n  // Update parent component when files change\n  React.useEffect(() => {\n    onFilesChange?.(files);\n  }, [files, onFilesChange]);\n\n  // File validation\n  const validateFile = (file: File): string | null => {\n    // Check file size\n    if (file.size > maxFileSize) {\n      return `File size exceeds ${formatFileSize(maxFileSize)}`;\n    }\n\n    // Check file type\n    if (allowedTypes && !allowedTypes.includes(file.type)) {\n      return `File type not allowed. Allowed types: ${allowedTypes.join(', ')}`;\n    }\n\n    return null;\n  };\n\n  // Process files (resize, compress, etc.)\n  const processFile = async (file: File): Promise<File> => {\n    if (file.type.startsWith('image/') && (resizeImages || compress)) {\n      return await processImage(file, resizeImages, compress);\n    }\n    return file;\n  };\n\n  // Generate preview for file\n  const generatePreview = async (file: File): Promise<string | undefined> => {\n    if (file.type.startsWith('image/')) {\n      return new Promise((resolve) => {\n        const reader = new FileReader();\n        reader.onload = (e) => resolve(e.target?.result as string);\n        reader.readAsDataURL(file);\n      });\n    }\n    return undefined;\n  };\n\n  // Handle file selection\n  const handleFileSelect = async (selectedFiles: FileList) => {\n    const newFiles: UploadedFile[] = [];\n\n    // Check if we would exceed max files\n    if (files.length + selectedFiles.length > maxFiles) {\n      alert(`Maximum ${maxFiles} file${maxFiles > 1 ? 's' : ''} allowed`);\n      return;\n    }\n\n    for (let i = 0; i < selectedFiles.length; i++) {\n      const file = selectedFiles[i];\n      const validation = validateFile(file);\n\n      if (validation) {\n        const uploadedFile: UploadedFile = {\n          id: generateId(),\n          file,\n          name: file.name,\n          size: file.size,\n          type: file.type,\n          status: 'error',\n          error: validation\n        };\n        newFiles.push(uploadedFile);\n        continue;\n      }\n\n      try {\n        const processedFile = await processFile(file);\n        const preview = showPreview ? await generatePreview(processedFile) : undefined;\n\n        const uploadedFile: UploadedFile = {\n          id: generateId(),\n          file: processedFile,\n          name: processedFile.name,\n          size: processedFile.size,\n          type: processedFile.type,\n          preview,\n          status: 'pending',\n          progress: 0\n        };\n\n        newFiles.push(uploadedFile);\n      } catch (error) {\n        const uploadedFile: UploadedFile = {\n          id: generateId(),\n          file,\n          name: file.name,\n          size: file.size,\n          type: file.type,\n          status: 'error',\n          error: 'Failed to process file'\n        };\n        newFiles.push(uploadedFile);\n      }\n    }\n\n    setFiles(prev => [...prev, ...newFiles]);\n\n    // Upload immediately if instantUpload is enabled\n    if (instantUpload && onUpload && newFiles.some(f => f.status === 'pending')) {\n      await handleUpload(newFiles.filter(f => f.status === 'pending'));\n    }\n  };\n\n  // Handle file upload\n  const handleUpload = async (filesToUpload?: UploadedFile[]) => {\n    const targetFiles = filesToUpload || files.filter(f => f.status === 'pending');\n    if (targetFiles.length === 0 || !onUpload) return;\n\n    setIsUploading(true);\n\n    try {\n      // Update status to uploading\n      setFiles(prev => prev.map(file => {\n        if (targetFiles.find(f => f.id === file.id)) {\n          return { ...file, status: 'uploading' as const, progress: 0 };\n        }\n        return file;\n      }));\n\n      // Simulate progress (in real implementation, you'd track actual upload progress)\n      const progressInterval = setInterval(() => {\n        setFiles(prev => prev.map(file => {\n          if (targetFiles.find(f => f.id === file.id) && file.status === 'uploading') {\n            const newProgress = Math.min((file.progress || 0) + Math.random() * 30, 95);\n            return { ...file, progress: newProgress };\n          }\n          return file;\n        }));\n      }, 500);\n\n      // Perform upload\n      await onUpload(targetFiles.map(f => f.file));\n\n      // Clear progress interval\n      clearInterval(progressInterval);\n\n      // Mark as success\n      setFiles(prev => prev.map(file => {\n        if (targetFiles.find(f => f.id === file.id)) {\n          return { ...file, status: 'success' as const, progress: 100 };\n        }\n        return file;\n      }));\n    } catch (error) {\n      // Mark as error\n      setFiles(prev => prev.map(file => {\n        if (targetFiles.find(f => f.id === file.id)) {\n          return { \n            ...file, \n            status: 'error' as const, \n            error: 'Upload failed',\n            progress: 0\n          };\n        }\n        return file;\n      }));\n    } finally {\n      setIsUploading(false);\n    }\n  };\n\n  // Remove file\n  const removeFile = (fileId: string) => {\n    setFiles(prev => prev.filter(f => f.id !== fileId));\n  };\n\n  // Retry upload\n  const retryUpload = (fileId: string) => {\n    const file = files.find(f => f.id === fileId);\n    if (file) {\n      handleUpload([file]);\n    }\n  };\n\n  // Drag and drop handlers\n  const handleDragEnter = (e: React.DragEvent) => {\n    e.preventDefault();\n    dragCounter.current++;\n    if (dragCounter.current === 1) {\n      setIsDragOver(true);\n    }\n  };\n\n  const handleDragLeave = (e: React.DragEvent) => {\n    e.preventDefault();\n    dragCounter.current--;\n    if (dragCounter.current === 0) {\n      setIsDragOver(false);\n    }\n  };\n\n  const handleDragOver = (e: React.DragEvent) => {\n    e.preventDefault();\n  };\n\n  const handleDrop = (e: React.DragEvent) => {\n    e.preventDefault();\n    setIsDragOver(false);\n    dragCounter.current = 0;\n\n    const droppedFiles = e.dataTransfer.files;\n    if (droppedFiles.length > 0) {\n      handleFileSelect(droppedFiles);\n    }\n  };\n\n  // File input change handler\n  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const selectedFiles = e.target.files;\n    if (selectedFiles) {\n      handleFileSelect(selectedFiles);\n    }\n    // Reset input value to allow selecting the same file again\n    if (fileInputRef.current) {\n      fileInputRef.current.value = '';\n    }\n  };\n\n  // Open file dialog\n  const openFileDialog = () => {\n    fileInputRef.current?.click();\n  };\n\n  const pendingFiles = files.filter(f => f.status === 'pending');\n  const hasFiles = files.length > 0;\n\n  return (\n    <div className={cn(\"space-y-4\", className)}>\n      {/* Label and description */}\n      {label && (\n        <div className=\"space-y-1\">\n          <label className=\"block text-sm font-medium\">\n            {label}\n            {required && <span className=\"text-[var(--color-error)] ml-1\">*</span>}\n          </label>\n          {description && (\n            <p className=\"text-sm text-[var(--color-muted-foreground)]\">{description}</p>\n          )}\n        </div>\n      )}\n\n      {/* Upload area */}\n      <div\n        className={cn(\n          \"relative border-2 border-dashed rounded-lg p-6 transition-all duration-200\",\n          {\n            \"border-[var(--color-border)] bg-[var(--color-muted)]/20\": !isDragOver && !error,\n            \"border-[var(--color-primary)] bg-[var(--color-primary)]/5\": isDragOver && !error,\n            \"border-[var(--color-error)] bg-[var(--color-error)]/5\": error,\n            \"opacity-50 cursor-not-allowed\": disabled,\n          }\n        )}\n        onDragEnter={dragAndDrop ? handleDragEnter : undefined}\n        onDragLeave={dragAndDrop ? handleDragLeave : undefined}\n        onDragOver={dragAndDrop ? handleDragOver : undefined}\n        onDrop={dragAndDrop ? handleDrop : undefined}\n      >\n        <input\n          ref={fileInputRef}\n          type=\"file\"\n          className=\"hidden\"\n          accept={accept}\n          multiple={multiple}\n          onChange={handleInputChange}\n          disabled={disabled}\n        />\n\n        <div className=\"text-center space-y-4\">\n          <div className=\"mx-auto w-12 h-12 text-[var(--color-muted-foreground)]\">\n            <Upload className=\"w-full h-full\" />\n          </div>\n          \n          <div className=\"space-y-2\">\n            <p className=\"text-sm font-medium\">\n              {dragAndDrop ? 'Drag files here or ' : ''}\n              <Button\n                type=\"button\"\n                variant=\"link\"\n                onClick={openFileDialog}\n                disabled={disabled}\n                className=\"p-0 h-auto font-medium\"\n              >\n                browse files\n              </Button>\n            </p>\n            \n            <div className=\"text-xs text-[var(--color-muted-foreground)] space-y-1\">\n              <p>Maximum {maxFiles} file{maxFiles > 1 ? 's' : ''}</p>\n              <p>Max size: {formatFileSize(maxFileSize)}</p>\n              {allowedTypes && (\n                <p>Allowed: {allowedTypes.join(', ')}</p>\n              )}\n            </div>\n          </div>\n        </div>\n      </div>\n\n      {/* Error message */}\n      {error && (\n        <div className=\"flex items-center gap-1 text-[var(--color-error)] text-sm\">\n          <AlertCircle className=\"w-4 h-4\" />\n          <span>{error}</span>\n        </div>\n      )}\n\n      {/* File list */}\n      {hasFiles && (\n        <div className=\"space-y-3\">\n          <div className=\"flex items-center justify-between\">\n            <h4 className=\"text-sm font-medium\">\n              Files ({files.length}/{maxFiles})\n            </h4>\n            \n            <div className=\"flex items-center gap-2\">\n              {pendingFiles.length > 0 && !instantUpload && (\n                <Button\n                  type=\"button\"\n                  size=\"sm\"\n                  onClick={() => handleUpload()}\n                  disabled={isUploading}\n                  className=\"flex items-center gap-2\"\n                >\n                  {isUploading && (\n                    <div className=\"animate-spin rounded-full h-3 w-3 border-b-2 border-white\"></div>\n                  )}\n                  Upload {pendingFiles.length} file{pendingFiles.length > 1 ? 's' : ''}\n                </Button>\n              )}\n              \n              <Button\n                type=\"button\"\n                variant=\"ghost\"\n                size=\"sm\"\n                onClick={() => setFiles([])}\n                className=\"text-[var(--color-muted-foreground)]\"\n              >\n                Clear all\n              </Button>\n            </div>\n          </div>\n\n          <div className=\"space-y-2\">\n            {files.map(file => (\n              <FilePreview\n                key={file.id}\n                file={file}\n                onRemove={() => removeFile(file.id)}\n                onRetry={() => retryUpload(file.id)}\n                showPreview={showPreview}\n              />\n            ))}\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n\n// File preview component\ninterface FilePreviewProps {\n  file: UploadedFile;\n  onRemove: () => void;\n  onRetry: () => void;\n  showPreview: boolean;\n}\n\nfunction FilePreview({ file, onRemove, onRetry, showPreview }: FilePreviewProps) {\n  const isImage = file.type.startsWith('image/');\n  const isVideo = file.type.startsWith('video/');\n  const isAudio = file.type.startsWith('audio/');\n  const isArchive = ['application/zip', 'application/x-rar-compressed', 'application/x-7z-compressed'].includes(file.type);\n\n  const getFileIcon = () => {\n    if (isImage) return <Image className=\"w-5 h-5\" />;\n    if (isVideo) return <Video className=\"w-5 h-5\" />;\n    if (isAudio) return <Music className=\"w-5 h-5\" />;\n    if (isArchive) return <Archive className=\"w-5 h-5\" />;\n    if (file.type === 'application/pdf' || file.type.includes('document')) {\n      return <FileText className=\"w-5 h-5\" />;\n    }\n    return <File className=\"w-5 h-5\" />;\n  };\n\n  const getStatusIcon = () => {\n    switch (file.status) {\n      case 'success':\n        return <Check className=\"w-4 h-4 text-[var(--color-success)]\" />;\n      case 'error':\n        return <AlertCircle className=\"w-4 h-4 text-[var(--color-error)]\" />;\n      case 'uploading':\n        return (\n          <div className=\"animate-spin rounded-full h-4 w-4 border-b-2 border-[var(--color-primary)]\"></div>\n        );\n      default:\n        return null;\n    }\n  };\n\n  return (\n    <div className={cn(\n      \"flex items-center gap-3 p-3 rounded-lg border transition-all duration-200\",\n      {\n        \"border-[var(--color-border)] bg-[var(--color-surface)]\": file.status === 'pending',\n        \"border-[var(--color-primary)] bg-[var(--color-primary)]/5\": file.status === 'uploading',\n        \"border-[var(--color-success)] bg-[var(--color-success)]/5\": file.status === 'success',\n        \"border-[var(--color-error)] bg-[var(--color-error)]/5\": file.status === 'error',\n      }\n    )}>\n      {/* File preview/icon */}\n      <div className=\"flex-shrink-0\">\n        {showPreview && file.preview ? (\n          <img\n            src={file.preview}\n            alt={file.name}\n            className=\"w-10 h-10 object-cover rounded\"\n          />\n        ) : (\n          <div className=\"w-10 h-10 flex items-center justify-center bg-[var(--color-muted)] rounded text-[var(--color-muted-foreground)]\">\n            {getFileIcon()}\n          </div>\n        )}\n      </div>\n\n      {/* File details */}\n      <div className=\"flex-1 min-w-0\">\n        <div className=\"flex items-center justify-between\">\n          <div className=\"min-w-0\">\n            <p className=\"text-sm font-medium truncate\">{file.name}</p>\n            <p className=\"text-xs text-[var(--color-muted-foreground)]\">\n              {formatFileSize(file.size)}\n            </p>\n          </div>\n          \n          <div className=\"flex items-center gap-2\">\n            {getStatusIcon()}\n            \n            {file.status === 'error' && (\n              <Button\n                type=\"button\"\n                variant=\"ghost\"\n                size=\"sm\"\n                onClick={onRetry}\n                className=\"p-1 h-auto\"\n                title=\"Retry upload\"\n              >\n                Retry\n              </Button>\n            )}\n            \n            <Button\n              type=\"button\"\n              variant=\"ghost\"\n              size=\"sm\"\n              onClick={onRemove}\n              className=\"p-1 h-auto text-[var(--color-muted-foreground)] hover:text-[var(--color-error)]\"\n              title=\"Remove file\"\n            >\n              <X className=\"w-4 h-4\" />\n            </Button>\n          </div>\n        </div>\n\n        {/* Progress bar */}\n        {file.status === 'uploading' && file.progress !== undefined && (\n          <div className=\"mt-2\">\n            <Progress value={file.progress} className=\"h-1\" />\n          </div>\n        )}\n\n        {/* Error message */}\n        {file.status === 'error' && file.error && (\n          <p className=\"text-xs text-[var(--color-error)] mt-1\">{file.error}</p>\n        )}\n      </div>\n    </div>\n  );\n}\n\n// Utility functions\nfunction generateId(): string {\n  return Math.random().toString(36).substr(2, 9);\n}\n\nfunction formatFileSize(bytes: number): string {\n  if (bytes === 0) return '0 Bytes';\n  const k = 1024;\n  const sizes = ['Bytes', 'KB', 'MB', 'GB'];\n  const i = Math.floor(Math.log(bytes) / Math.log(k));\n  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];\n}\n\nasync function processImage(\n  file: File,\n  resizeOptions?: { maxWidth: number; maxHeight: number; quality?: number },\n  compress?: boolean\n): Promise<File> {\n  return new Promise((resolve) => {\n    const canvas = document.createElement('canvas');\n    const ctx = canvas.getContext('2d');\n    const img = new Image();\n    \n    img.onload = () => {\n      let { width, height } = img;\n      \n      // Resize if needed\n      if (resizeOptions) {\n        const { maxWidth, maxHeight } = resizeOptions;\n        const ratio = Math.min(maxWidth / width, maxHeight / height);\n        if (ratio < 1) {\n          width *= ratio;\n          height *= ratio;\n        }\n      }\n      \n      canvas.width = width;\n      canvas.height = height;\n      \n      ctx?.drawImage(img, 0, 0, width, height);\n      \n      canvas.toBlob(\n        (blob) => {\n          if (blob) {\n            const processedFile = new File([blob], file.name, {\n              type: file.type,\n              lastModified: file.lastModified\n            });\n            resolve(processedFile);\n          } else {\n            resolve(file);\n          }\n        },\n        file.type,\n        resizeOptions?.quality || 0.9\n      );\n    };\n    \n    img.src = URL.createObjectURL(file);\n  });\n}