"use client";\n\nimport * as React from \"react\";\nimport { cn } from \"@/lib/utils\";\nimport { Button } from \"./button\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from \"./dialog\";\nimport { FormProgress } from \"./form-components\";\nimport { ChevronLeft, ChevronRight, Check } from \"lucide-react\";\n\n// Multi-step form wizard component\nexport interface FormStep {\n  id: string;\n  title: string;\n  subtitle?: string;\n  content: React.ReactNode;\n  validation?: () => Promise<boolean> | boolean;\n  optional?: boolean;\n}\n\nexport interface MultiStepFormProps {\n  steps: FormStep[];\n  currentStep: number;\n  onStepChange: (step: number) => void;\n  onComplete: () => void;\n  onCancel?: () => void;\n  className?: string;\n  showProgress?: boolean;\n  progressVariant?: \"dots\" | \"line\" | \"numbered\";\n  allowSkipSteps?: boolean;\n  validateOnNext?: boolean;\n  persistProgress?: boolean;\n}\n\nexport function MultiStepForm({\n  steps,\n  currentStep,\n  onStepChange,\n  onComplete,\n  onCancel,\n  className,\n  showProgress = true,\n  progressVariant = \"numbered\",\n  allowSkipSteps = false,\n  validateOnNext = true,\n  persistProgress = true\n}: MultiStepFormProps) {\n  const [completedSteps, setCompletedSteps] = React.useState<Set<number>>(new Set());\n  const [isValidating, setIsValidating] = React.useState(false);\n  const [validationError, setValidationError] = React.useState<string>(\"\");\n  \n  const currentStepData = steps[currentStep];\n  const isFirstStep = currentStep === 0;\n  const isLastStep = currentStep === steps.length - 1;\n  const canGoNext = currentStep < steps.length - 1;\n  const canGoPrev = currentStep > 0;\n\n  // Persist progress to localStorage\n  React.useEffect(() => {\n    if (persistProgress) {\n      const progressData = {\n        currentStep,\n        completedSteps: Array.from(completedSteps)\n      };\n      localStorage.setItem('multiStepFormProgress', JSON.stringify(progressData));\n    }\n  }, [currentStep, completedSteps, persistProgress]);\n\n  // Load progress from localStorage\n  React.useEffect(() => {\n    if (persistProgress) {\n      const savedProgress = localStorage.getItem('multiStepFormProgress');\n      if (savedProgress) {\n        try {\n          const { currentStep: savedStep, completedSteps: savedCompleted } = JSON.parse(savedProgress);\n          if (savedStep !== undefined && savedCompleted) {\n            onStepChange(savedStep);\n            setCompletedSteps(new Set(savedCompleted));\n          }\n        } catch (error) {\n          console.warn('Failed to restore form progress:', error);\n        }\n      }\n    }\n  }, [persistProgress, onStepChange]);\n\n  const handleNext = async () => {\n    setValidationError(\"\");\n    \n    if (validateOnNext && currentStepData.validation) {\n      setIsValidating(true);\n      try {\n        const isValid = await currentStepData.validation();\n        if (!isValid) {\n          setValidationError(\"Please fix the errors in this step before continuing.\");\n          setIsValidating(false);\n          return;\n        }\n      } catch (error) {\n        setValidationError(\"Validation failed. Please check your inputs.\");\n        setIsValidating(false);\n        return;\n      }\n      setIsValidating(false);\n    }\n    \n    // Mark current step as completed\n    setCompletedSteps(prev => new Set([...prev, currentStep]));\n    \n    if (isLastStep) {\n      onComplete();\n    } else {\n      onStepChange(currentStep + 1);\n    }\n  };\n\n  const handlePrevious = () => {\n    setValidationError(\"\");\n    if (canGoPrev) {\n      onStepChange(currentStep - 1);\n    }\n  };\n\n  const handleStepClick = async (stepIndex: number) => {\n    if (!allowSkipSteps) return;\n    if (stepIndex === currentStep) return;\n    \n    // If going forward, validate intermediate steps\n    if (stepIndex > currentStep && validateOnNext) {\n      for (let i = currentStep; i < stepIndex; i++) {\n        const step = steps[i];\n        if (step.validation) {\n          const isValid = await step.validation();\n          if (!isValid && !step.optional) {\n            setValidationError(`Please complete step ${i + 1} before proceeding.`);\n            return;\n          }\n        }\n      }\n    }\n    \n    onStepChange(stepIndex);\n  };\n\n  const clearProgress = () => {\n    if (persistProgress) {\n      localStorage.removeItem('multiStepFormProgress');\n    }\n    setCompletedSteps(new Set());\n    onStepChange(0);\n  };\n\n  return (\n    <div className={cn(\"space-y-6\", className)}>\n      {/* Progress indicator */}\n      {showProgress && (\n        <div className=\"space-y-4\">\n          <FormProgress\n            steps={steps.map(s => s.title)}\n            currentStep={currentStep}\n            variant={progressVariant}\n          />\n          \n          {allowSkipSteps && (\n            <div className=\"flex flex-wrap gap-2 justify-center\">\n              {steps.map((step, index) => {\n                const isCompleted = completedSteps.has(index);\n                const isCurrent = index === currentStep;\n                const isAccessible = allowSkipSteps || index <= Math.max(...Array.from(completedSteps), currentStep);\n                \n                return (\n                  <Button\n                    key={step.id}\n                    type=\"button\"\n                    variant={isCurrent ? \"default\" : isCompleted ? \"secondary\" : \"ghost\"}\n                    size=\"sm\"\n                    disabled={!isAccessible}\n                    onClick={() => handleStepClick(index)}\n                    className={cn(\n                      \"text-xs\",\n                      isCurrent && \"ring-2 ring-[var(--color-primary)] ring-offset-2\"\n                    )}\n                  >\n                    {isCompleted && <Check className=\"w-3 h-3 mr-1\" />}\n                    {step.title}\n                  </Button>\n                );\n              })}\n            </div>\n          )}\n        </div>\n      )}\n      \n      {/* Step content */}\n      <div className=\"space-y-4\">\n        {/* Step header */}\n        <div className=\"space-y-2\">\n          <h2 className=\"text-2xl font-bold text-[var(--color-foreground)]\">\n            {currentStepData.title}\n          </h2>\n          {currentStepData.subtitle && (\n            <p className=\"text-[var(--color-muted-foreground)]\">\n              {currentStepData.subtitle}\n            </p>\n          )}\n          {currentStepData.optional && (\n            <span className=\"inline-flex items-center px-2 py-1 rounded-full text-xs bg-[var(--color-muted)] text-[var(--color-muted-foreground)]\">\n              Optional\n            </span>\n          )}\n        </div>\n        \n        {/* Validation error */}\n        {validationError && (\n          <div className=\"p-3 rounded-md bg-[var(--color-error)]/10 border border-[var(--color-error)]/20\">\n            <p className=\"text-sm text-[var(--color-error)]\">{validationError}</p>\n          </div>\n        )}\n        \n        {/* Step content */}\n        <div className=\"min-h-[300px]\">\n          {currentStepData.content}\n        </div>\n      </div>\n      \n      {/* Navigation buttons */}\n      <div className=\"flex items-center justify-between pt-6 border-t border-[var(--color-border)]\">\n        <div className=\"flex items-center gap-3\">\n          {canGoPrev && (\n            <Button\n              type=\"button\"\n              variant=\"ghost\"\n              onClick={handlePrevious}\n              disabled={isValidating}\n              className=\"flex items-center gap-2\"\n            >\n              <ChevronLeft className=\"w-4 h-4\" />\n              Previous\n            </Button>\n          )}\n          \n          {persistProgress && completedSteps.size > 0 && (\n            <Button\n              type=\"button\"\n              variant=\"ghost\"\n              onClick={clearProgress}\n              disabled={isValidating}\n              className=\"text-[var(--color-muted-foreground)] text-sm\"\n            >\n              Clear Progress\n            </Button>\n          )}\n        </div>\n        \n        <div className=\"flex items-center gap-3\">\n          {onCancel && (\n            <Button\n              type=\"button\"\n              variant=\"ghost\"\n              onClick={onCancel}\n              disabled={isValidating}\n            >\n              Cancel\n            </Button>\n          )}\n          \n          {currentStepData.optional && !isLastStep && (\n            <Button\n              type=\"button\"\n              variant=\"secondary\"\n              onClick={() => onStepChange(currentStep + 1)}\n              disabled={isValidating}\n            >\n              Skip\n            </Button>\n          )}\n          \n          <Button\n            type=\"button\"\n            onClick={handleNext}\n            disabled={isValidating}\n            className=\"flex items-center gap-2\"\n          >\n            {isValidating && (\n              <div className=\"animate-spin rounded-full h-4 w-4 border-b-2 border-white\"></div>\n            )}\n            {isLastStep ? 'Complete' : 'Next'}\n            {!isLastStep && <ChevronRight className=\"w-4 h-4\" />}\n          </Button>\n        </div>\n      </div>\n    </div>\n  );\n}\n\n// Multi-step form dialog wrapper\nexport interface MultiStepFormDialogProps extends Omit<MultiStepFormProps, 'onCancel'> {\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n  title?: string;\n  description?: string;\n  maxWidth?: \"sm\" | \"md\" | \"lg\" | \"xl\" | \"2xl\";\n}\n\nexport function MultiStepFormDialog({\n  open,\n  onOpenChange,\n  title,\n  description,\n  maxWidth = \"lg\",\n  ...formProps\n}: MultiStepFormDialogProps) {\n  const handleCancel = () => {\n    onOpenChange(false);\n  };\n\n  const handleComplete = () => {\n    formProps.onComplete();\n    onOpenChange(false);\n  };\n\n  const maxWidthClasses = {\n    sm: \"max-w-md\",\n    md: \"max-w-lg\",\n    lg: \"max-w-2xl\",\n    xl: \"max-w-4xl\",\n    \"2xl\": \"max-w-6xl\"\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent className={cn(\"max-h-[90vh] overflow-y-auto\", maxWidthClasses[maxWidth])}>\n        {(title || description) && (\n          <DialogHeader>\n            {title && <DialogTitle>{title}</DialogTitle>}\n            {description && (\n              <p className=\"text-sm text-[var(--color-muted-foreground)]\">{description}</p>\n            )}\n          </DialogHeader>\n        )}\n        \n        <MultiStepForm\n          {...formProps}\n          onComplete={handleComplete}\n          onCancel={handleCancel}\n          className=\"py-4\"\n        />\n      </DialogContent>\n    </Dialog>\n  );\n}\n\n// Hook for managing multi-step form state\nexport function useMultiStepForm(steps: FormStep[], options?: {\n  initialStep?: number;\n  persistProgress?: boolean;\n}) {\n  const [currentStep, setCurrentStep] = React.useState(options?.initialStep || 0);\n  const [isOpen, setIsOpen] = React.useState(false);\n  \n  const next = React.useCallback(() => {\n    setCurrentStep(prev => Math.min(prev + 1, steps.length - 1));\n  }, [steps.length]);\n  \n  const previous = React.useCallback(() => {\n    setCurrentStep(prev => Math.max(prev - 1, 0));\n  }, []);\n  \n  const goToStep = React.useCallback((step: number) => {\n    setCurrentStep(Math.max(0, Math.min(step, steps.length - 1)));\n  }, [steps.length]);\n  \n  const reset = React.useCallback(() => {\n    setCurrentStep(0);\n    if (options?.persistProgress) {\n      localStorage.removeItem('multiStepFormProgress');\n    }\n  }, [options?.persistProgress]);\n  \n  const openDialog = React.useCallback(() => {\n    setIsOpen(true);\n  }, []);\n  \n  const closeDialog = React.useCallback(() => {\n    setIsOpen(false);\n  }, []);\n  \n  return {\n    currentStep,\n    isOpen,\n    next,\n    previous,\n    goToStep,\n    reset,\n    openDialog,\n    closeDialog,\n    setCurrentStep,\n    setIsOpen\n  };\n}