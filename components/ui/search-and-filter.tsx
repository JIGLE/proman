import * as React from \"react\"\nimport { Search, Filter, SlidersHorizontal, X } from \"lucide-react\"\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"./button\"\nimport { Input } from \"./input\"\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n  DropdownMenuCheckboxItem,\n  DropdownMenuSeparator,\n  DropdownMenuLabel\n} from \"./dropdown-menu\"\nimport { Badge } from \"./badge\"\n\ninterface FilterOption {\n  label: string\n  value: string\n}\n\ninterface FilterGroup {\n  key: string\n  label: string\n  options: FilterOption[]\n  multiple?: boolean\n  defaultValue?: string | string[]\n}\n\ninterface SearchAndFilterProps {\n  searchValue: string\n  onSearchChange: (value: string) => void\n  placeholder?: string\n  filters?: FilterGroup[]\n  onFiltersChange?: (filters: Record<string, string | string[]>) => void\n  className?: string\n  showFilterCount?: boolean\n}\n\nexport function SearchAndFilter({\n  searchValue,\n  onSearchChange,\n  placeholder = \"Search...\",\n  filters = [],\n  onFiltersChange,\n  className,\n  showFilterCount = true\n}: SearchAndFilterProps) {\n  const [activeFilters, setActiveFilters] = React.useState<Record<string, string | string[]>>({})\n  const [isFilterOpen, setIsFilterOpen] = React.useState(false)\n\n  React.useEffect(() => {\n    // Initialize filters with default values\n    const initialFilters: Record<string, string | string[]> = {}\n    filters.forEach(filter => {\n      if (filter.defaultValue) {\n        initialFilters[filter.key] = filter.defaultValue\n      }\n    })\n    setActiveFilters(initialFilters)\n  }, [filters])\n\n  React.useEffect(() => {\n    onFiltersChange?.(activeFilters)\n  }, [activeFilters, onFiltersChange])\n\n  const handleFilterChange = (filterKey: string, value: string, multiple = false) => {\n    setActiveFilters(prev => {\n      const current = prev[filterKey]\n      \n      if (multiple) {\n        const currentArray = Array.isArray(current) ? current : []\n        const newArray = currentArray.includes(value)\n          ? currentArray.filter(v => v !== value)\n          : [...currentArray, value]\n        \n        return {\n          ...prev,\n          [filterKey]: newArray.length > 0 ? newArray : undefined\n        }\n      } else {\n        return {\n          ...prev,\n          [filterKey]: current === value ? undefined : value\n        }\n      }\n    })\n  }\n\n  const clearFilter = (filterKey: string) => {\n    setActiveFilters(prev => {\n      const newFilters = { ...prev }\n      delete newFilters[filterKey]\n      return newFilters\n    })\n  }\n\n  const clearAllFilters = () => {\n    setActiveFilters({})\n  }\n\n  const getActiveFilterCount = () => {\n    return Object.keys(activeFilters).filter(key => {\n      const value = activeFilters[key]\n      if (Array.isArray(value)) {\n        return value.length > 0\n      }\n      return value !== undefined\n    }).length\n  }\n\n  const getFilterDisplayValue = (filter: FilterGroup) => {\n    const value = activeFilters[filter.key]\n    if (!value) return null\n    \n    if (Array.isArray(value)) {\n      return value.length > 0 ? `${value.length} selected` : null\n    }\n    \n    const option = filter.options.find(opt => opt.value === value)\n    return option?.label || value\n  }\n\n  return (\n    <div className={cn(\"space-y-4\", className)}>\n      {/* Search and Filter Bar */}\n      <div className=\"flex items-center gap-3\">\n        {/* Search Input */}\n        <div className=\"relative flex-1 max-w-md\">\n          <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-zinc-400\" />\n          <Input\n            placeholder={placeholder}\n            value={searchValue}\n            onChange={(e) => onSearchChange(e.target.value)}\n            className=\"pl-10 focus-ring\"\n          />\n          {searchValue && (\n            <button\n              onClick={() => onSearchChange(\"\")}\n              className=\"absolute right-3 top-1/2 transform -translate-y-1/2 text-zinc-400 hover:text-zinc-200 transition-colors\"\n            >\n              <X className=\"h-4 w-4\" />\n            </button>\n          )}\n        </div>\n\n        {/* Filter Dropdown */}\n        {filters.length > 0 && (\n          <DropdownMenu open={isFilterOpen} onOpenChange={setIsFilterOpen}>\n            <DropdownMenuTrigger asChild>\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                className={cn(\n                  \"gap-2 relative\",\n                  getActiveFilterCount() > 0 && \"border-accent-primary/50 text-accent-primary\"\n                )}\n              >\n                <SlidersHorizontal className=\"h-4 w-4\" />\n                <span>Filters</span>\n                {showFilterCount && getActiveFilterCount() > 0 && (\n                  <Badge variant=\"secondary\" size=\"sm\" className=\"ml-1 h-5 px-1.5\">\n                    {getActiveFilterCount()}\n                  </Badge>\n                )}\n              </Button>\n            </DropdownMenuTrigger>\n            \n            <DropdownMenuContent align=\"end\" className=\"w-64 surface-overlay\">\n              <DropdownMenuLabel className=\"flex items-center justify-between\">\n                <span>Filter Options</span>\n                {getActiveFilterCount() > 0 && (\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    onClick={clearAllFilters}\n                    className=\"h-auto p-0 text-xs text-zinc-400 hover:text-zinc-200\"\n                  >\n                    Clear all\n                  </Button>\n                )}\n              </DropdownMenuLabel>\n              \n              <DropdownMenuSeparator />\n              \n              {filters.map((filter, index) => (\n                <div key={filter.key}>\n                  <DropdownMenuLabel className=\"text-xs font-medium text-zinc-400 uppercase tracking-wider\">\n                    {filter.label}\n                  </DropdownMenuLabel>\n                  \n                  {filter.options.map((option) => {\n                    const isActive = filter.multiple\n                      ? Array.isArray(activeFilters[filter.key]) && \n                        (activeFilters[filter.key] as string[]).includes(option.value)\n                      : activeFilters[filter.key] === option.value\n                    \n                    return filter.multiple ? (\n                      <DropdownMenuCheckboxItem\n                        key={option.value}\n                        checked={isActive}\n                        onCheckedChange={() => handleFilterChange(filter.key, option.value, true)}\n                      >\n                        {option.label}\n                      </DropdownMenuCheckboxItem>\n                    ) : (\n                      <DropdownMenuItem\n                        key={option.value}\n                        onClick={() => handleFilterChange(filter.key, option.value, false)}\n                        className={cn(isActive && \"bg-accent-primary/10 text-accent-primary\")}\n                      >\n                        {option.label}\n                        {isActive && <span className=\"ml-auto\">âœ“</span>}\n                      </DropdownMenuItem>\n                    )\n                  })}\n                  \n                  {index < filters.length - 1 && <DropdownMenuSeparator />}\n                </div>\n              ))}\n            </DropdownMenuContent>\n          </DropdownMenu>\n        )}\n      </div>\n\n      {/* Active Filters */}\n      {getActiveFilterCount() > 0 && (\n        <div className=\"flex items-center gap-2 flex-wrap\">\n          <span className=\"text-xs text-zinc-500 font-medium\">Active filters:</span>\n          \n          {filters.map((filter) => {\n            const displayValue = getFilterDisplayValue(filter)\n            if (!displayValue) return null\n            \n            return (\n              <Badge\n                key={filter.key}\n                variant=\"secondary\"\n                className=\"gap-1 cursor-pointer hover:bg-red-500/10 hover:text-red-400 transition-colors\"\n                onClick={() => clearFilter(filter.key)}\n              >\n                <span>{filter.label}: {displayValue}</span>\n                <X className=\"h-3 w-3\" />\n              </Badge>\n            )\n          })}\n        </div>\n      )}\n    </div>\n  )\n}\n