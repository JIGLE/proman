name: Release - Publish to GHCR

on:
  push:
    tags: ['v*']
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run as dry run (true/false)'
        required: false
        default: 'false'
      version:
        description: 'Optional version override (e.g., 1.2.3)'
        required: false
        default: ''

permissions:
  contents: write
  packages: write
  id-token: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

jobs:
  release:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
      DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set Variables
        id: vars
        run: |
          # Determine version
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
            VERSION=${VERSION#refs/tags/}
          else
            VERSION="${{ github.event.inputs.version }}"
            if [ -z "$VERSION" ]; then
              VERSION=$(grep '"version":' package.json | cut -d'"' -f4)
            fi
          fi
          
          # Compute lowercase names for registries
          OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          REPO_NAME_LOWER=$(echo "${{ github.event.repository.name }}" | tr '[:upper:]' '[:lower:]')
          
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "owner_lower=${OWNER_LOWER}" >> $GITHUB_OUTPUT
          echo "repo_lower=${REPO_NAME_LOWER}" >> $GITHUB_OUTPUT
          echo "full_repo_ghcr=ghcr.io/${OWNER_LOWER}/${REPO_NAME_LOWER}" >> $GITHUB_OUTPUT
          
          # Build Time and Commit
          echo "build_time=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT
          echo "git_commit=${{ github.sha }}" >> $GITHUB_OUTPUT
        shell: bash

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Login to GitHub Container Registry (GHCR)
        if: env.DRY_RUN != 'true'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_PAT || secrets.GITHUB_TOKEN }}

      - name: Login to Docker Hub
        if: env.DRY_RUN != 'true' && secrets.DOCKERHUB_USERNAME != '' && secrets.DOCKERHUB_TOKEN != ''
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Login to Custom Registry
        if: env.DRY_RUN != 'true' && secrets.REGISTRY != '' && secrets.REGISTRY_USERNAME != '' && secrets.REGISTRY_PASSWORD != ''
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.REGISTRY }}
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Docker Metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ghcr.io/${{ steps.vars.outputs.owner_lower }}/${{ steps.vars.outputs.repo_lower }}
            ${{ secrets.DOCKERHUB_USERNAME != '' && format('{0}/{1}', secrets.DOCKERHUB_USERNAME, steps.vars.outputs.repo_lower) || '' }}
            ${{ secrets.REGISTRY != '' && format('{0}/{1}/{2}', secrets.REGISTRY, secrets.REGISTRY_USERNAME, steps.vars.outputs.repo_lower) || '' }}
          tags: |
            type=raw,value=${{ steps.vars.outputs.version }}
            type=raw,value=latest,enable=${{ github.ref == format('refs/heads/{0}', github.event.repository.default_branch) || startsWith(github.ref, 'refs/tags/v') }}
            type=sha

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: ${{ env.DRY_RUN != 'true' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILD_VERSION=${{ steps.vars.outputs.version }}
            GIT_COMMIT=${{ steps.vars.outputs.git_commit }}
            BUILD_TIME=${{ steps.vars.outputs.build_time }}

      - name: Package Helm Chart
        run: |
          chmod +x ./scripts/package-helm-and-verify.sh
          ./scripts/package-helm-and-verify.sh release-charts "${{ steps.vars.outputs.version }}"

      - name: Create GitHub Release
        if: env.DRY_RUN != 'true' && startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          name: Release v${{ steps.vars.outputs.version }}
          body: |
            ## ProMan Release v${{ steps.vars.outputs.version }}
            
            Multi-arch Docker images are available at:
            - `ghcr.io/${{ steps.vars.outputs.owner_lower }}/${{ steps.vars.outputs.repo_lower }}:${{ steps.vars.outputs.version }}`
            
            To install on TrueNAS SCALE or any Kubernetes cluster:
            1. Download the `proman-${{ steps.vars.outputs.version }}.tgz` chart from this release.
            2. Follow the instructions in [README_TRUENAS.md](https://github.com/${{ github.repository }}/blob/main/README_TRUENAS.md).
          files: release-charts/*.tgz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
