# File (intended final path): `.github/workflows/release-publish.yml` — purpose: release/publish (build images, package helm, create release)
name: Release - Publish to GHCR

on:
  push:
    tags: ['v*']
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run as dry run (true/false)'
        required: false
        default: 'true'
      version:
        description: 'Optional version override (e.g., 1.2.3)'
        required: false
        default: ''
  schedule:
    - cron: '0 6 * * 1' # weekly on Monday at 06:00 UTC (DRY_RUN)

permissions:
  contents: write
  packages: write
  id-token: write

# Job outputs: verify will publish whether this is a dry run so downstream diagnostic job can conditionally run


concurrency:
  group: publish-ghcr-${{ github.ref }}
  cancel-in-progress: true

jobs:
  smoke:
    runs-on: ubuntu-latest
    # This unconditional smoke job helps diagnose whether workflows are allowed to run.
    steps:
      - name: Checkout
        uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98
        with:
          fetch-depth: 0
      - name: Show basic context
        run: |
          echo "SMOKE CHECK"
          echo "EVENT: ${GITHUB_EVENT_NAME}"
          echo "REF: ${GITHUB_REF}"
          echo "SHA: ${GITHUB_SHA}"
          uname -a
          whoami || true
          ls -la || true
          if [ -z "${{ secrets.GHCR_PAT }}" ]; then echo "GHCR_PAT_PRESENT=false" > smoke.txt; else echo "GHCR_PAT_PRESENT=true" > smoke.txt; fi
      - name: Upload smoke artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
        with:
          name: smoke
          path: smoke.txt

  verify:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    outputs:
      dry_run: ${{ steps.dryrun.outputs.dry_run }}
    steps:
      - name: Checkout
        uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98
        with:
          fetch-depth: 0

      - name: Set DRY_RUN for scheduled runs and tag pushes
        id: dryrun
        run: |
          if [ "${GITHUB_EVENT_NAME}" = "schedule" ] || [[ "${GITHUB_REF:-}" == refs/tags/* ]]; then
            echo "DRY_RUN=true" >> $GITHUB_ENV
            echo "dry_run=true" >> $GITHUB_OUTPUT
            echo "Scheduled or tag run — setting DRY_RUN=true"
          else
            DRY=${{ github.event.inputs.dry_run || 'false' }}
            echo "DRY_RUN=${DRY}" >> $GITHUB_ENV
            echo "dry_run=${DRY}" >> $GITHUB_OUTPUT
          fi
        shell: bash

      - name: Setup Node.js
        uses: actions/setup-node@65d868f8d4d85d7d4abb7de0875cde3fcc8798f5
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: Install dependencies
        run: npm ci

      - name: Type-check + lint
        run: |
          npm run type-check || (echo "Type-check failed" && false)
          npm run lint || (echo "Lint failed" && false)

  diagnostic:
    needs: verify
    runs-on: ubuntu-latest
    if: needs.verify.outputs.dry_run == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98
        with:
          fetch-depth: 0
      - name: Setup Node.js
        uses: actions/setup-node@65d868f8d4d85d7d4abb7de0875cde3fcc8798f5
        with:
          node-version: '20'
      - name: Install dependencies
        run: npm ci
      - name: Build (dry-run)
        run: |
          rm -rf .next
          npm run build
      - name: Set VERSION for diagnostic
        id: set-vars
        run: |
          set -euo pipefail
          if [[ "${GITHUB_REF:-}" == refs/tags/* ]]; then
            TAG=${GITHUB_REF#refs/tags/}
            TAG=${TAG#v}
            if [ -n "${{ github.event.inputs.version }}" ]; then
              VERSION="${{ github.event.inputs.version }}"
            else
              VERSION="$TAG"
            fi
          else
            if [ -n "${{ github.event.inputs.version }}" ]; then
              VERSION="${{ github.event.inputs.version }}"
            else
              VERSION=$(node -e 'console.log(require("./package.json").version)')
            fi
          fi
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
      - name: Package Helm chart (verify)
        run: |
          set -euo pipefail
          # Use the verification helper which sets both Chart.version and appVersion, lints, packages, and verifies Chart.yaml
          ./scripts/package-helm-and-verify.sh release-charts "${VERSION}"
        shell: bash
        shell: bash
      - name: Upload artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
        with:
          name: release-charts-dryrun
          path: release-charts

  build-and-publish:
    needs: verify
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
      DRY_RUN: ${{ needs.verify.outputs.dry_run }}

    steps:
      - name: Checkout
        uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Setup Node.js
        uses: actions/setup-node@65d868f8d4d85d7d4abb7de0875cde3fcc8798f5
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: Install dependencies
        run: npm ci

      - name: Clean build
        run: |
          rm -rf .next
          npm run build

      - id: set-vars
        run: |
          set -euo pipefail
          if [[ "${GITHUB_REF:-}" == refs/tags/* ]]; then
            TAG=${GITHUB_REF#refs/tags/}
            TAG=${TAG#v}
            if [ -n "${{ github.event.inputs.version }}" ]; then
              VERSION="${{ github.event.inputs.version }}"
            else
              VERSION="$TAG"
            fi
          else
            if [ -n "${{ github.event.inputs.version }}" ]; then
              VERSION="${{ github.event.inputs.version }}"
            else
              VERSION=$(node -e 'console.log(require("./package.json").version)')
            fi
          fi
          # compute lowercase owner for GHCR tags
          OWNER_LOWER=$(echo "${GITHUB_REPOSITORY%%/*}" | tr '[:upper:]' '[:lower:]')

          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "GIT_COMMIT=${GITHUB_SHA}" >> $GITHUB_OUTPUT
          echo "BUILD_TIME=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT
          echo "OWNER_LOWER=${OWNER_LOWER}" >> $GITHUB_OUTPUT
        shell: bash

      - name: "Sanity check: ensure VERSION computed"
        run: |
          if [ -z "${{ steps.set-vars.outputs.VERSION }}" ]; then
            echo "ERROR: VERSION is empty; aborting"
            exit 1
          else
            echo "VERSION=${{ steps.set-vars.outputs.VERSION }}"
          fi
        shell: bash

      - name: Set up QEMU
        uses: docker/setup-qemu-action@45136fd328ae20ed788d00d3bada68ab496c214c

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@c7c4c00f3eef127be487a50899a220e44c6bcc87

      - name: Ensure publish credentials available (non-dry-run)
        if: needs.verify.outputs.dry_run != 'true'
        run: |
          if [ -z "${{ secrets.GHCR_PAT }}" ]; then
            echo "ERROR: GHCR_PAT secret is not set. For non-dry-run publishes we require a Personal Access Token with packages:write. Aborting.";
            exit 1;
          else
            echo "GHCR_PAT present"
          fi
      - name: Login to GitHub Container Registry (GHCR)
        if: needs.verify.outputs.dry_run != 'true'
        uses: docker/login-action@916386b00027d425839f8da46d302dab33f5875b
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_PAT }}

      - name: Build and push multi-arch image
        uses: docker/build-push-action@64c9b141502b80dbbd71e008a0130ad330f480f8
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          cache-from: type=gha
          cache-to: type=gha,mode=max
          push: ${{ env.DRY_RUN != 'true' }}
          tags: |
            ghcr.io/${{ steps.set-vars.outputs.OWNER_LOWER }}/proman:${{ steps.set-vars.outputs.VERSION }}
            ghcr.io/${{ steps.set-vars.outputs.OWNER_LOWER }}/proman:latest
            ghcr.io/${{ steps.set-vars.outputs.OWNER_LOWER }}/proman:${{ github.sha }}
          build-args: |
            BUILD_VERSION=${{ steps.set-vars.outputs.VERSION }}
            GIT_COMMIT=${{ steps.set-vars.outputs.GIT_COMMIT }}
            BUILD_TIME=${{ steps.set-vars.outputs.BUILD_TIME }}

      - name: Image info
        run: |
          if [ "${DRY_RUN:-false}" = "true" ]; then
            echo "DRY_RUN: image push was skipped for ghcr.io/${{ github.repository_owner }}/proman:${{ steps.set-vars.outputs.VERSION }}"
          else
            echo "Image pushed: ghcr.io/${{ github.repository_owner }}/proman:${{ steps.set-vars.outputs.VERSION }}"
          fi

      - name: Package Helm chart with appVersion (verify)
        run: |
          set -euo pipefail
          # Use the verification helper which sets Chart.version and appVersion, lints, packages, and verifies Chart.yaml
          ./scripts/package-helm-and-verify.sh release-charts "${{ steps.set-vars.outputs.VERSION }}"
        shell: bash

      - name: Upload packaged chart for DRY_RUN inspection
        if: ${{ env.DRY_RUN == 'true' }}
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
        with:
          name: release-charts
          path: release-charts

      - name: Extract release note for body
        id: release_note
        run: |
          VERSION=${{ steps.set-vars.outputs.VERSION }}
          awk '/^## Releases/{flag=1; next} /^## / && flag{exit} flag{print}' README.md > releases-section.txt || true

          if [ -s releases-section.txt ]; then
            awk -v ver="$VERSION" '
              { lines[NR]=$0 }
              $0 ~ ("- Version:[[:space:]]*" ver) { target=NR }
              END {
                if (target) {
                  s=target-3; if (s<1) s=1
                  e=target+6; if (e>NR) e=NR
                  for(i=s;i<=e;i++) print lines[i]
                }
              }' releases-section.txt > release-note.txt || true
          fi

          if [ -s release-note.txt ]; then
            cat release-note.txt
            echo "note<<EOF" >> $GITHUB_OUTPUT
            cat release-note.txt >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "note<<EOF" >> $GITHUB_OUTPUT
            echo "Automated release for ${VERSION}" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: "DRY-RUN: Show intended tag & release"
        if: ${{ env.DRY_RUN == 'true' }}
        run: |
          echo "DRY_RUN enabled — would create tag v${{ steps.set-vars.outputs.VERSION }} and release with extracted note"
          echo "Release note preview:"
          cat release-note.txt || true

      - name: Create annotated git tag and push
        if: ${{ env.DRY_RUN != 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ steps.set-vars.outputs.VERSION }}
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "actions@github.com"
          git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}
          git fetch --no-tags
          if git rev-parse "refs/tags/v${VERSION}" >/dev/null 2>&1; then
            echo "Tag v${VERSION} already exists"
          else
            git tag -a "v${VERSION}" -m "Release v${VERSION}"
            git push origin "v${VERSION}"
          fi

      - name: Create GitHub Release
        if: ${{ env.DRY_RUN != 'true' }}
        id: create_release
        uses: actions/create-release@4c11c9fe1dcd9636620a16455165783b20fc7ea0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag_name: v${{ steps.set-vars.outputs.VERSION }}
          release_name: v${{ steps.set-vars.outputs.VERSION }}
          body: ${{ steps.release_note.outputs.note }}

      - name: Upload packaged chart to release
        if: ${{ env.DRY_RUN != 'true' }}
        uses: softprops/action-gh-release@78237c54eb15310cb292a15480c4be010be47aeb
        with:
          files: "release-charts/proman-*.tgz"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}