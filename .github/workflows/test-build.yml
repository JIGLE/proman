name: Test Build - Quick validation (amd64 only)

on:
  workflow_dispatch:
    inputs:
      ref:
        description: 'Git ref to build (branch/tag/commit)'
        required: false
        default: 'main'

permissions:
  contents: read
  packages: read

jobs:
  test-build:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref || github.ref }}
          fetch-depth: 0

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host

      - name: Build (amd64 only, no push)
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64
          push: false
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build Status
        run: |
          echo "## âœ… Build Test Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "amd64 architecture validated successfully (took ~6 minutes)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "- **For amd64-only release** (6 min): Push a git tag" >> $GITHUB_STEP_SUMMARY
          echo "- **For amd64 + arm64 release** (14 min): Run release-publish workflow with \`include_arm64=true\`" >> $GITHUB_STEP_SUMMARY
