name: CI - Tests (mock & sqlite)

on:
  push:
    branches: [ main, '**/test/**', '**/ci/**' ]
  pull_request:
    branches: [ main ]

jobs:
  test-mock:
    name: Tests (in-memory mock)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
      - name: Install deps
        run: npm ci
      - name: Run verify (type-check, lint, tests)
        run: npm run verify:ci

  test-sqlite:
    name: Tests (sqlite DATABASE_URL)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
      - name: Install deps
        run: npm ci
      - name: Create sqlite file
        run: |
          mkdir -p ${{ github.workspace }}
          touch ${{ github.workspace }}/ci-test.db
      - name: SQLite DB info (debug)
        run: |
          echo "ci-test.db details:"
          ls -l ${{ github.workspace }}/ci-test.db || true
          echo "Tables in DB:"
          sqlite3 ${{ github.workspace }}/ci-test.db ".tables" || true
      - name: Run prisma db push
        env:
          DATABASE_URL: file:./ci-test.db
        run: npx prisma db push --accept-data-loss
      - name: Run verify (sqlite) (type-check, lint, tests)
        env:
          DATABASE_URL: file:./ci-test.db
        run: npm run verify:ci

  docker-build:
    name: Docker Build (PR smoke test)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build image (no push)
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64
          push: false
          load: true
          tags: proman-pr:${{ github.sha }}
